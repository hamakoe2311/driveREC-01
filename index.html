<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- ビューポート設定：ズーム禁止とセーフエリア対応 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mobile Dashcam</title>
    <style>
        /* 基本設定 */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden; /* スクロール禁止 */
            font-family: sans-serif;
            color: white;
        }

        /* ビデオを全画面背景として配置 */
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* 最背面 */
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 画面いっぱいに広げる */
        }

        /* 速度などのオーバーレイ（ビデオの上） */
        .overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            text-shadow: 2px 2px 4px #000;
            background-color: rgba(0,0,0,0.3); /* 文字を見やすく */
            padding: 5px;
            border-radius: 4px;
            pointer-events: none; /* タップを透過させる */
        }

        #speed-display {
            font-size: 2.5rem; /* スマホ向けに少し調整 */
            font-weight: bold;
            color: #00ffcc;
        }

        #status-display {
            font-size: 0.9rem;
            color: #ffcc00;
        }

        /* 操作パネル（画面最下部に固定・最前面） */
        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px; /* 高さ固定 */
            background: rgba(0, 0, 0, 0.6); /* 半透明 */
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100; /* 確実に一番手前に表示 */
            
            /* iPhoneのホームバー(下部の線)対策 */
            padding-bottom: env(safe-area-inset-bottom); 
            box-sizing: content-box;
        }

        /* ボタンのデザイン */
        button {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            /* タップ時の反応を良くする */
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* 押したときのアニメーション */
        button:active {
            transform: scale(0.9);
            background-color: rgba(255,255,255,0.2);
        }

        .btn-start {
            width: 70px;
            height: 70px;
            background: #28a745;
            font-size: 13px;
        }

        .btn-save {
            width: 80px;
            height: 80px;
            background: #dc3545;
            font-size: 15px;
            display: none;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.6);
        }

        .btn-switch {
            width: 50px;
            height: 50px;
            background: #007bff;
            font-size: 11px;
        }

        /* ログエリア */
        .log-area {
            position: absolute;
            bottom: 120px; /* コントロールパネルの上 */
            left: 10px;
            right: 10px;
            height: 60px;
            overflow-y: hidden;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
            z-index: 5;
            pointer-events: none; /* ここをタップしても裏の映像には影響しない */
            text-shadow: 1px 1px 1px black;
        }

        /* 録画中の赤丸 */
        .recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 15px;
            height: 15px;
            background-color: red;
            border-radius: 50%;
            display: none;
            z-index: 15;
            box-shadow: 0 0 5px red;
        }
        .blink {
            animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
            50% { opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="video-container">
        <!-- playsinlineはiOSで必須 -->
        <video id="preview" autoplay playsinline muted></video>
    </div>
        
    <div class="overlay">
        <div id="speed-display">--- km/h</div>
        <div id="status-display">待機中</div>
    </div>

    <div id="recording-dot" class="recording-indicator"></div>
    <div id="logs" class="log-area"></div>

    <div id="controls">
        <button id="btn-switch" class="btn-switch">カメラ<br>切替</button>
        <button id="btn-start" class="btn-start">開始</button>
        <button id="btn-save" class="btn-save">保存</button>
    </div>

<script>
    // --- 設定 ---
    const PRE_RECORD_SECONDS = 60;
    const POST_RECORD_SECONDS = 60;
    const CHUNK_DURATION_MS = 1000;

    // --- 変数 ---
    let stream = null;
    let mediaRecorder = null;
    let watchId = null;
    let chunksBuffer = [];
    let isSavingEvent = false;
    let eventChunks = [];
    let postRecordCounter = 0;
    let currentFacingMode = 'environment'; // 'environment' or 'user'
    let wakeLock = null;

    // --- DOM要素 ---
    const videoEl = document.getElementById('preview');
    const speedEl = document.getElementById('speed-display');
    const statusEl = document.getElementById('status-display');
    const btnStart = document.getElementById('btn-start');
    const btnSave = document.getElementById('btn-save');
    const btnSwitch = document.getElementById('btn-switch');
    const recDot = document.getElementById('recording-dot');
    const logArea = document.getElementById('logs');

    // --- ユーティリティ ---
    function log(msg) {
        const div = document.createElement('div');
        const time = new Date().toLocaleTimeString('ja-JP', { hour12: false });
        div.textContent = `[${time}] ${msg}`;
        logArea.prepend(div);
        if(logArea.children.length > 4) logArea.lastChild.remove();
        console.log(msg);
    }

    // --- Wake Lock (画面常時点灯) ---
    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                log("画面スリープ防止ON");
            } catch (err) {
                log("WakeLock失敗: " + err.message);
            }
        }
    }

    // --- カメラ処理 ---
    async function startCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }

        const constraints = {
            audio: true, // 音声も録音
            video: {
                facingMode: { exact: currentFacingMode }, // exactを使うと切替が確実
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // PCなどexact非対応環境へのフォールバック
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (e) {
            // exact指定で失敗した場合は緩い指定で再トライ
            constraints.video.facingMode = currentFacingMode;
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                alert("カメラ起動エラー: " + err.message);
                return;
            }
        }

        videoEl.srcObject = stream;
        
        // 映像がロードされたら再生を確実にする
        videoEl.onloadedmetadata = () => {
            videoEl.play();
        };

        setupRecorder();
        log(currentFacingMode === 'environment' ? "背面カメラ" : "前面カメラ");
    }

    // --- 録画処理 (MediaRecorder) ---
    function setupRecorder() {
        let mimeType = '';
        const types = [
            'video/webm;codecs=vp9',
            'video/webm;codecs=vp8',
            'video/mp4' // iOS 14.5+ 対応
        ];

        for (const t of types) {
            if (MediaRecorder.isTypeSupported(t)) {
                mimeType = t;
                break;
            }
        }

        const options = mimeType ? { mimeType } : {};
        
        try {
            mediaRecorder = new MediaRecorder(stream, options);
        } catch (e) {
            alert("録画の初期化に失敗: " + e.message);
            return;
        }

        mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
                handleDataAvailable(e.data);
            }
        };

        mediaRecorder.start(CHUNK_DURATION_MS);
        recDot.style.display = 'block';
        recDot.classList.add('blink');
        statusEl.textContent = "録画中 (バッファ)";
        statusEl.style.color = '#ffcc00';
    }

    function handleDataAvailable(dataBlob) {
        if (isSavingEvent) {
            // 保存モード
            eventChunks.push(dataBlob);
            postRecordCounter++;
            const remaining = POST_RECORD_SECONDS - postRecordCounter;
            statusEl.textContent = `保存中... 残り${remaining}秒`;
            statusEl.style.color = 'red';

            if (remaining <= 0) {
                finalizeEventVideo();
            }
        } else {
            // 常時録画モード（古いデータを捨てる）
            chunksBuffer.push(dataBlob);
            if (chunksBuffer.length > PRE_RECORD_SECONDS) {
                chunksBuffer.shift();
            }
        }
    }

    // --- イベント保存 ---
    function triggerSave() {
        if (isSavingEvent) return;
        
        isSavingEvent = true;
        postRecordCounter = 0;
        eventChunks = [...chunksBuffer]; // 過去データをコピー
        
        log("イベント保存開始");
        btnSave.disabled = true;
        btnSave.textContent = "処理中";
        btnSave.style.opacity = "0.5";
    }

    function finalizeEventVideo() {
        log("ファイル生成中...");
        const blob = new Blob(eventChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        const now = new Date();
        const filename = `dashcam_${now.getFullYear()}${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}${now.getSeconds()}.webm`;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        
        // クリーンアップ
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            btnSave.disabled = false;
            btnSave.textContent = "保存";
            btnSave.style.opacity = "1";
            
            isSavingEvent = false;
            eventChunks = [];
            statusEl.textContent = "録画中 (バッファ)";
            statusEl.style.color = '#ffcc00';
            log("保存完了・常時録画復帰");
        }, 1000); // スマホでの処理落ちを防ぐため少し待つ
    }

    // --- GPS ---
    function startGPS() {
        if (!navigator.geolocation) {
            speedEl.textContent = "GPS不可";
            return;
        }
        watchId = navigator.geolocation.watchPosition(
            (pos) => {
                const speed = pos.coords.speed; // m/s
                if (speed === null || speed < 0) {
                    speedEl.textContent = "0 km/h";
                } else {
                    // m/s -> km/h
                    const kmh = (speed * 3.6).toFixed(0);
                    speedEl.textContent = `${kmh} km/h`;
                }
            },
            (err) => {
                console.warn("GPS Error: " + err.code);
            },
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            }
        );
    }

    // --- イベントリスナー ---
    
    // 開始ボタン
    btnStart.addEventListener('click', async () => {
        // ボタン切り替え
        btnStart.style.display = 'none';
        btnSave.style.display = 'block';
        
        await requestWakeLock();
        startGPS();
        await startCamera();
    });

    // 保存ボタン
    btnSave.addEventListener('click', (e) => {
        e.preventDefault(); // ダブルタップズームなどを防止
        triggerSave();
    });

    // カメラ切替ボタン
    btnSwitch.addEventListener('click', async (e) => {
        e.preventDefault();
        // カメラの反転
        currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
        
        // レコーダー停止
        if(mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        
        // 少し待ってから再起動（スマホのカメラ解放待ち）
        statusEl.textContent = "カメラ切替中...";
        setTimeout(async () => {
            await startCamera();
        }, 500);
    });

    // ページ離脱時
    window.addEventListener('beforeunload', () => {
        if (watchId) navigator.geolocation.clearWatch(watchId);
    });

</script>
</body>
</html>
